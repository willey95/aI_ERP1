// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================== User & Auth Models ==================

enum UserRole {
  ADMIN
  CFO
  TEAM_LEAD
  RM_TEAM
  MANAGER
  STAFF
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String
  name        String
  department  String
  role        UserRole @default(STAFF)
  position    String
  phoneNumber String?  @map("phone_number")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  createdProjects Project[]        @relation("ProjectCreator")
  executions      Execution[]      @relation("ExecutionCreator")
  approvals       ApprovalHistory[]

  @@map("users")
}

// ================== Project Models ==================

enum ProjectType {
  SELF
  SPC
  JOINT
  COOPERATIVE
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  COMPLETED
  SUSPENDED
}

model Project {
  id         String        @id @default(uuid())
  name       String
  type       ProjectType
  status     ProjectStatus @default(PLANNING)
  startDate  DateTime      @map("start_date")
  endDate    DateTime      @map("end_date")
  location   String
  targetROI  Float         @map("target_roi")
  riskScore  Int           @default(0) @map("risk_score")

  // Scale information (stored as JSON)
  totalArea  Float         @map("total_area")
  units      Int
  floors     Int

  // Relations
  createdBy  String        @map("created_by")
  creator    User          @relation("ProjectCreator", fields: [createdBy], references: [id])

  budgetItems BudgetItem[]
  executions  Execution[]

  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  @@map("projects")
}

// ================== Budget Models ==================

enum BudgetCategory {
  REVENUE
  EXPENSE
}

enum BudgetItemType {
  PRESALE       // 분양수입
  RENTAL        // 임대수입
  LAND          // 토지비
  CONSTRUCTION  // 공사비
  DESIGN        // 설계/감리
  CONTRIBUTIONS // 부담금
  FINANCE       // 금융비용
  MARKETING     // 마케팅
  OTHER         // 기타
}

model BudgetItem {
  id              String          @id @default(uuid())
  projectId       String          @map("project_id")
  project         Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  category        BudgetCategory
  type            BudgetItemType
  name            String
  code            String          // Budget code (e.g., "R-001", "E-001")

  // For hierarchical structure
  parentId        String?         @map("parent_id")
  parent          BudgetItem?     @relation("BudgetHierarchy", fields: [parentId], references: [id])
  children        BudgetItem[]    @relation("BudgetHierarchy")

  initialAmount   Decimal         @map("initial_amount") @db.Decimal(20, 2)
  currentAmount   Decimal         @map("current_amount") @db.Decimal(20, 2)
  executedAmount  Decimal         @default(0) @map("executed_amount") @db.Decimal(20, 2)

  description     String?

  executions      Execution[]
  changes         BudgetChange[]

  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@unique([projectId, code])
  @@map("budget_items")
}

model BudgetChange {
  id             String      @id @default(uuid())
  budgetItemId   String      @map("budget_item_id")
  budgetItem     BudgetItem  @relation(fields: [budgetItemId], references: [id], onDelete: Cascade)

  previousAmount Decimal     @map("previous_amount") @db.Decimal(20, 2)
  newAmount      Decimal     @map("new_amount") @db.Decimal(20, 2)
  changeAmount   Decimal     @map("change_amount") @db.Decimal(20, 2)
  reason         String

  approvedBy     String      @map("approved_by")
  approvedAt     DateTime    @map("approved_at")

  createdAt      DateTime    @default(now()) @map("created_at")

  @@map("budget_changes")
}

// ================== Execution Models ==================

enum ExecutionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalStep {
  MANAGER
  TEAM_LEAD
  RM_TEAM
  CFO
}

model Execution {
  id              String          @id @default(uuid())
  executionNumber String          @unique @map("execution_number") // EXE-2024-0001

  projectId       String          @map("project_id")
  project         Project         @relation(fields: [projectId], references: [id])

  budgetItemId    String          @map("budget_item_id")
  budgetItem      BudgetItem      @relation(fields: [budgetItemId], references: [id])

  amount          Decimal         @db.Decimal(20, 2)
  executionDate   DateTime        @map("execution_date")
  justification   String          @db.Text

  status          ExecutionStatus @default(DRAFT)
  currentStep     ApprovalStep?   @map("current_step")

  createdBy       String          @map("created_by")
  creator         User            @relation("ExecutionCreator", fields: [createdBy], references: [id])

  attachments     Attachment[]
  approvalHistory ApprovalHistory[]

  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  submittedAt     DateTime?       @map("submitted_at")
  approvedAt      DateTime?       @map("approved_at")
  rejectedAt      DateTime?       @map("rejected_at")

  @@map("executions")
}

model Attachment {
  id          String    @id @default(uuid())
  executionId String    @map("execution_id")
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  fileName    String    @map("file_name")
  fileSize    Int       @map("file_size")
  fileType    String    @map("file_type")
  fileUrl     String    @map("file_url")

  uploadedAt  DateTime  @default(now()) @map("uploaded_at")

  @@map("attachments")
}

// ================== Approval Models ==================

enum ApprovalAction {
  APPROVED
  REJECTED
}

model ApprovalHistory {
  id          String          @id @default(uuid())
  executionId String          @map("execution_id")
  execution   Execution       @relation(fields: [executionId], references: [id], onDelete: Cascade)

  step        ApprovalStep
  action      ApprovalAction

  approverId  String          @map("approver_id")
  approver    User            @relation(fields: [approverId], references: [id])

  comment     String?         @db.Text
  timestamp   DateTime        @default(now())

  @@map("approval_history")
}

// ================== Analytics & Cache Models ==================

model CashFlowProjection {
  id               String   @id @default(uuid())
  projectId        String   @map("project_id")

  month            DateTime
  plannedRevenue   Decimal  @map("planned_revenue") @db.Decimal(20, 2)
  plannedExpense   Decimal  @map("planned_expense") @db.Decimal(20, 2)
  actualRevenue    Decimal  @default(0) @map("actual_revenue") @db.Decimal(20, 2)
  actualExpense    Decimal  @default(0) @map("actual_expense") @db.Decimal(20, 2)

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([projectId, month])
  @@map("cashflow_projections")
}

model Simulation {
  id              String   @id @default(uuid())
  projectId       String   @map("project_id")

  name            String
  scenarioData    Json     @map("scenario_data") // Stores simulation parameters
  resultData      Json     @map("result_data")   // Stores simulation results

  createdBy       String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("simulations")
}

// ================== Notifications ==================

enum NotificationType {
  EXECUTION_SUBMITTED
  EXECUTION_APPROVED
  EXECUTION_REJECTED
  BUDGET_ALERT
  RISK_ALERT
  SYSTEM
}

model Notification {
  id        String            @id @default(uuid())
  userId    String            @map("user_id")
  type      NotificationType
  title     String
  message   String            @db.Text
  data      Json?             // Additional data
  isRead    Boolean           @default(false) @map("is_read")
  createdAt DateTime          @default(now()) @map("created_at")

  @@map("notifications")
}

// ================== Financial Model & Cash Flow ==================

enum DataType {
  ACTUAL    // 실적 (고정, ERP에서 가져온 데이터)
  FORECAST  // 전망 (수정 가능, 추정치)
}

enum ScenarioType {
  BASE      // 기본 시나리오
  OPTIMISTIC // 낙관적
  PESSIMISTIC // 비관적
  CUSTOM    // 사용자 정의
}

// 재무모델 메인 (프로젝트별 사업수지)
model FinancialModel {
  id            String   @id @default(uuid())
  projectId     String   @map("project_id")

  name          String   // 모델 이름 (e.g., "2024년 1차 수정")
  version       String   // 버전 (e.g., "v1.0", "v2.1")
  isActive      Boolean  @default(true) @map("is_active") // 활성 모델 여부

  baseDate      DateTime @map("base_date") // 기준일
  startDate     DateTime @map("start_date") // 시작일
  endDate       DateTime @map("end_date")   // 종료일

  description   String?  @db.Text
  metadata      Json?    // 추가 메타데이터 (ERP 연동 정보 등)

  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  cfItems       CashFlowItem[]
  scenarios     Scenario[]

  @@unique([projectId, version])
  @@map("financial_models")
}

// CF 항목 (수입/지출 항목 정의)
model CashFlowItem {
  id                String   @id @default(uuid())
  financialModelId  String   @map("financial_model_id")
  financialModel    FinancialModel @relation(fields: [financialModelId], references: [id], onDelete: Cascade)

  code              String   // 항목 코드 (e.g., "R-001", "E-001")
  name              String   // 항목명 (e.g., "분양수입", "공사비")
  category          BudgetCategory // REVENUE or EXPENSE
  type              BudgetItemType

  // 계층 구조
  parentId          String?  @map("parent_id")
  parent            CashFlowItem? @relation("CFItemHierarchy", fields: [parentId], references: [id])
  children          CashFlowItem[] @relation("CFItemHierarchy")

  order             Int      @default(0) // 표시 순서
  isCalculated      Boolean  @default(false) @map("is_calculated") // 계산식 항목 여부
  formula           String?  // 계산식 (JSON 형태)

  // ERP 매핑 정보
  erpSource         String?  @map("erp_source") // ERP 시스템 출처
  erpCode           String?  @map("erp_code")   // ERP 항목 코드
  erpLastSync       DateTime? @map("erp_last_sync") // 마지막 동기화 시간

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  cfData            CashFlowData[]
  cellNotes         CellNote[]

  @@unique([financialModelId, code])
  @@map("cashflow_items")
}

// CF 실제 데이터 (월별/분기별 실적/전망)
model CashFlowData {
  id            String   @id @default(uuid())
  cfItemId      String   @map("cf_item_id")
  cfItem        CashFlowItem @relation(fields: [cfItemId], references: [id], onDelete: Cascade)

  scenarioId    String?  @map("scenario_id") // null이면 기본 시나리오
  scenario      Scenario? @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  period        DateTime // 기간 (월/분기 시작일)
  dataType      DataType // ACTUAL or FORECAST

  amount        Decimal  @db.Decimal(20, 2)

  // 메타 정보
  source        String?  // 데이터 출처 (ERP, 수동입력, AI추정 등)
  confidence    Float?   // 신뢰도 (0-1)
  note          String?  @db.Text // 간단한 메모

  // ERP 연동 정보
  erpReference  String?  @map("erp_reference") // ERP 참조 ID
  erpSyncedAt   DateTime? @map("erp_synced_at")
  isLocked      Boolean  @default(false) @map("is_locked") // 실적 데이터는 잠금

  createdBy     String?  @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([cfItemId, period, dataType, scenarioId])
  @@index([cfItemId, period])
  @@index([scenarioId])
  @@map("cashflow_data")
}

// 시나리오 관리 (여러 전망치 비교)
model Scenario {
  id                String   @id @default(uuid())
  financialModelId  String   @map("financial_model_id")
  financialModel    FinancialModel @relation(fields: [financialModelId], references: [id], onDelete: Cascade)

  name              String   // 시나리오 이름
  type              ScenarioType
  description       String?  @db.Text

  // 시나리오 가정
  assumptions       Json     // 시나리오별 가정 (분양률, 금리, 공사비 인상률 등)

  isBaseline        Boolean  @default(false) @map("is_baseline") // 기준 시나리오 여부
  isActive          Boolean  @default(true) @map("is_active")

  // 결과 요약
  totalRevenue      Decimal? @map("total_revenue") @db.Decimal(20, 2)
  totalExpense      Decimal? @map("total_expense") @db.Decimal(20, 2)
  netProfit         Decimal? @map("net_profit") @db.Decimal(20, 2)
  roi               Float?
  irr               Float?

  createdBy         String   @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  cfData            CashFlowData[]

  @@unique([financialModelId, name])
  @@map("scenarios")
}

// 셀 단위 메모 (각 CF 데이터에 대한 상세 메모)
model CellNote {
  id          String   @id @default(uuid())
  cfItemId    String   @map("cf_item_id")
  cfItem      CashFlowItem @relation(fields: [cfItemId], references: [id], onDelete: Cascade)

  period      DateTime // 기간

  title       String?
  content     String   @db.Text
  tags        String[] // 태그 (검색용)

  attachments Json?    // 첨부파일 정보

  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([cfItemId, period])
  @@map("cell_notes")
}

// ERP 연동 이력
model ERPSyncLog {
  id            String   @id @default(uuid())
  projectId     String   @map("project_id")

  syncType      String   // IMPORT or EXPORT
  status        String   // SUCCESS, FAILED, PARTIAL

  itemsCount    Int      @map("items_count")
  successCount  Int      @map("success_count")
  failedCount   Int      @map("failed_count")

  errorLog      Json?    @map("error_log")
  metadata      Json?

  startedAt     DateTime @map("started_at")
  completedAt   DateTime? @map("completed_at")

  createdBy     String   @map("created_by")

  @@map("erp_sync_logs")
}
